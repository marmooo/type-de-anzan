const countPanel=document.getElementById("countPanel"),infoPanel=document.getElementById("infoPanel"),playPanel=document.getElementById("playPanel"),scorePanel=document.getElementById("scorePanel"),gameTime=180;let gameTimer,hinted=!1,correctCount=0,audioContext;const audioBufferCache={};loadConfig();function loadConfig(){localStorage.getItem("darkMode")==1&&document.documentElement.setAttribute("data-bs-theme","dark")}function toggleDarkMode(){localStorage.getItem("darkMode")==1?(localStorage.setItem("darkMode",0),document.documentElement.setAttribute("data-bs-theme","light")):(localStorage.setItem("darkMode",1),document.documentElement.setAttribute("data-bs-theme","dark"))}function createAudioContext(){return globalThis.AudioContext?new globalThis.AudioContext:(console.error("Web Audio API is not supported in this browser"),null)}function unlockAudio(){audioContext?audioContext.resume():(audioContext=createAudioContext(),loadAudio("end","mp3/end.mp3"),loadAudio("correct","mp3/correct3.mp3"),loadAudio("incorrect","mp3/incorrect1.mp3")),document.removeEventListener("pointerdown",unlockAudio),document.removeEventListener("keydown",unlockAudio)}async function loadAudio(e,t){if(!audioContext)return;if(audioBufferCache[e])return audioBufferCache[e];try{const s=await fetch(t),o=await s.arrayBuffer(),n=await audioContext.decodeAudioData(o);return audioBufferCache[e]=n,n}catch(t){throw console.error(`Loading audio ${e} error:`,t),t}}function playAudio(e,t){if(!audioContext)return;const o=audioBufferCache[e];if(!o){console.error(`Audio ${e} is not found in cache`);return}const n=audioContext.createBufferSource();n.buffer=o;const s=audioContext.createGain();t&&(s.gain.value=t),s.connect(audioContext.destination),n.connect(s),n.start()}function getNumRange(e){switch(e){case 1:return[8,2,8,2,0,0,0,0];case 2:return[28,6,28,6,8,2,0,0];case 3:return[38,11,38,11,8,2,8,2];case 4:return[38,11,38,11,12,2,16,4];case 5:return[99,50,99,50,16,4,20,6];case 6:return[99,50,99,50,14,6,20,8];case 7:return[388,111,388,111,12,8,20,11];default:return[8888,1111,8888,1111,88,11,88,11]}}function generateData(){hinted=!1;const a=document.getElementById("gradeOption").selectedIndex+1,r=document.getElementById("courseOption").selectedIndex-1,e=getNumRange(a);let n,t,s,o,i;switch(r<0?a==1?i=Math.floor(Math.random()*2):a==2?i=Math.floor(Math.random()*3):i=Math.floor(Math.random()*4):i=r,i){case 0:n=Math.floor(Math.random()*e[0]+e[1]),t=Math.floor(Math.random()*e[0]+e[1]),s=n+t,o="＋";break;case 1:t=Math.floor(Math.random()*e[2]+e[3]),s=Math.floor(Math.random()*e[2]+e[3]),n=t+s,o="−";break;case 2:n=Math.floor(Math.random()*e[4]+e[5]),t=Math.floor(Math.random()*e[4]+e[5]),s=n*t,o="×";break;case 3:t=Math.floor(Math.random()*e[6]+e[7]),s=Math.floor(Math.random()*e[6]+e[7]),n=t*s,o="÷";break;default:console.log("error")}const c=document.getElementById("num");c.textContent=`${n}${o}${t}＝`,document.getElementById("reply").dataset.answer=s}function countdown(){correctCount=0,countPanel.classList.remove("d-none"),playPanel.classList.add("d-none"),infoPanel.classList.add("d-none"),scorePanel.classList.add("d-none");const e=document.getElementById("counter");e.textContent=3;const t=setInterval(()=>{const n=["skyblue","greenyellow","violet","tomato"];if(parseInt(e.textContent)>1){const t=parseInt(e.textContent)-1;e.style.backgroundColor=n[t],e.textContent=t}else clearInterval(t),countPanel.classList.add("d-none"),playPanel.classList.remove("d-none"),infoPanel.classList.remove("d-none"),generateData(),startGameTimer()},1e3)}function startGame(){clearInterval(gameTimer),initTime(),countdown()}function startGameTimer(){const e=document.getElementById("time");initTime(),gameTimer=setInterval(()=>{const t=parseInt(e.textContent);t>0?e.textContent=t-1:(clearInterval(gameTimer),playAudio("end"),playPanel.classList.add("d-none"),scorePanel.classList.remove("d-none"),scoring())},1e3)}function initTime(){document.getElementById("time").textContent=gameTime}function scoring(){document.getElementById("score").textContent=correctCount}function initCalc(){const e=document.getElementById("reply");document.getElementById("be").onclick=()=>{hinted||(hinted=!0,e.textContent=e.dataset.answer),playAudio("incorrect",.3),setTimeout(()=>{e.textContent="",generateData()},3e3)},document.getElementById("bc").onclick=()=>{e.textContent=""};for(let t=0;t<10;t++)document.getElementById("b"+t).onclick=t=>{let n=e.textContent;n+=t.target.getAttribute("id").slice(-1),n.length>6&&(n=n.slice(1,7)),e.textContent=n;const s=e.dataset.answer;s==n&&(playAudio("correct",.3),e.textContent="",hinted||(correctCount+=1),generateData())}}initCalc(),generateData(),document.getElementById("toggleDarkMode").onclick=toggleDarkMode,document.getElementById("startButton").onclick=startGame,document.getElementById("restartButton").onclick=startGame,document.addEventListener("pointerdown",unlockAudio,{once:!0}),document.addEventListener("keydown",unlockAudio,{once:!0})